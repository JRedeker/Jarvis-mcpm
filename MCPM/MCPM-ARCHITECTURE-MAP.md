# MCPM Architecture Map

This document provides a comprehensive map of the MCPM (Model Context Protocol Manager) system architecture, file structure, and component relationships within the `MCPM` subdirectory.

## 1. System Overview

**MCPM (Model Context Protocol Manager)** is the core ecosystem for managing MCP servers. It consists of two primary layers: the **MCPM CLI** for low-level operations and **Jarvis**, a specialized MCP server that acts as an intelligent management gateway.

### Core Components

*   **MCPM (CLI):** The primary command-line interface for installing, configuring, and managing MCP servers. It handles package downloads, environment configuration, and IDE config generation.
*   **Jarvis (Management Server):** A specialized MCP server that wraps the `mcpm` CLI. It exposes management capabilities (install, list, search, configure) as MCP tools, allowing AI agents to programmatically manage the ecosystem.
*   **MCP Servers:** Independent services providing specific capabilities (e.g., file system access, web search, GitHub integration). These run as local processes (stdio) managed by the IDEs.
*   **Qdrant:** A vector database used by specific MCP servers (like `memory`) for semantic search and storage.
*   **PostgreSQL:** Optional backend for specific tools requiring relational data storage.

## 2. Architecture Diagram

```mermaid
graph TD
    subgraph Clients
        IDE1[Cline IDE]
        IDE2[Kilo Code IDE]
    end

    subgraph "Local Environment"
        
        subgraph "Management Layer"
            Jarvis[Jarvis Server]
            MCPM[MCPM CLI]
        end
        
        subgraph "Managed Processes (stdio)"
            S1[brave-search]
            S2[filesystem]
            S3[firecrawl]
            S4[morph-fast-apply]
            S5[gpt-researcher]
            S6[fetch]
            S7[github]
            S8[memory]
            S9[playwright]
            S10[sqlite]
        end
        
        subgraph "Infrastructure Services"
            DB[(PostgreSQL :5432)]
            Vector[(Qdrant :6333)]
        end
    end

    IDE1 -->|Spawns/Uses| Jarvis
    IDE2 -->|Spawns/Uses| Jarvis
    
    Jarvis -->|Executes| MCPM
    MCPM -->|Installs/Configures| S1
    MCPM -->|Installs/Configures| S2
    MCPM -->|Installs/Configures| S8
    
    IDE1 -->|Spawns| S1
    IDE1 -->|Spawns| S2
    IDE2 -->|Spawns| S8
    
    S8 -->|Stores Vectors| Vector
    S10 -->|Stores Data| DB
```

## 3. File Structure & Key Files

### MCPM Directory (`./`)
*   `package.json`: Node.js dependencies, including `mcpm`.
*   `config/`: Configuration directory.
    *   `technologies.toml`: Central registry of all supported MCP technologies.

### Jarvis Directory (`../Jarvis`)
*   `main.go`: Entry point for the Jarvis MCP server.
*   `jarvis`: Compiled binary.

### Documentation (See Root `docs/`)
*   `architecture/`: Detailed architectural documents.
    *   `optimization-roadmap.md`: Plans for system optimization and the role of `mcpm`.
*   `config/`: Configuration documentation.
    *   `port-allocation.md`: Matrix of ports used by infrastructure services.
    *   `tool-groups.md`: Definitions for tool grouping strategies.
*   `guides/`: User and setup guides.
    *   `server-registration.md`: How to install and register servers using `mcpm`.
    *   `ide-configuration.md`: Generating IDE configurations with `mcpm`.
*   `tech/`: Technical documentation for individual MCP servers.

## 4. Component Relationships

### Jarvis <-> MCPM CLI
*   **Relationship:** Wrapper / Execution
*   **Mechanism:** Jarvis runs as an MCP server and executes `mcpm` CLI commands as subprocesses to perform actions like installing servers or updating configurations. This allows AI agents to "drive" the CLI.

### MCPM <-> MCP Servers
*   **Relationship:** Management
*   **Mechanism:** `mcpm` installs server packages from npm or git, manages their environment variables, and generates the JSON configuration required by IDEs to spawn them.

### IDEs <-> MCP Servers
*   **Relationship:** Execution
*   **Mechanism:** IDEs read the configuration generated by `mcpm` and spawn server processes directly using `stdio` transport. There is no intermediate gateway for standard tool usage.

### IDEs <-> Jarvis
*   **Relationship:** Management Interface
*   **Mechanism:** IDEs spawn Jarvis just like any other MCP server. Agents use Jarvis tools (`install_server`, `search_servers`) to modify the system state.

### MCP Servers <-> Infrastructure
*   **Relationship:** Persistence
*   **Mechanism:** Specific servers connect to local infrastructure services.
    *   `memory` server connects to **Qdrant** (port 6333) for vector storage.
    *   `sqlite` or custom servers may connect to **PostgreSQL** (port 5432).

## 5. Key Data Flows

1.  **Agent-Driven Installation:** Agent calls Jarvis tool `install_server("sqlite")` -> Jarvis executes `mcpm install sqlite` -> MCPM downloads package.
2.  **Manual Configuration:** User runs `mcpm config` -> MCPM outputs JSON config -> User updates IDE settings.
3.  **Runtime:** IDE starts -> Spawns configured MCP servers (including Jarvis) -> Servers communicate via stdio -> Servers access local resources or APIs.

## 6. Technology Stack

*   **Management Gateway:** `Jarvis` (Go).
*   **CLI Engine:** `mcpm` (Node.js CLI).
*   **Runtime:** Node.js (for most servers), Python (for specific AI/ML servers).
*   **Infrastructure:** Docker (hosting Qdrant, PostgreSQL).
*   **Protocol:** Model Context Protocol (MCP) over `stdio`.