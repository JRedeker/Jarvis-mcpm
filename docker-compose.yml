services:
  postgres:
    image: postgres:15
    container_name: mcp-postgres
    environment:
      POSTGRES_USER: mcp
      POSTGRES_PASSWORD: mcp_password
      POSTGRES_DB: mcp_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mcp"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - mcp-network

  qdrant:
    image: qdrant/qdrant:latest
    container_name: mcp-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/6333'"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - mcp-network

  mcpm-daemon:
    build:
      context: ./mcpm-daemon
      dockerfile: Dockerfile
    container_name: mcp-daemon
    # Streamable HTTP endpoints (MCP 2025-03-26 spec)
    # Connect via: http://localhost:<port>/mcp
    # MCPM API Server: http://localhost:6275/api/v1
    ports:
      - "6275:6275"  # MCPM API Server
      - "6276:6276"  # p-pokeedge
      - "6277:6277"  # memory
      - "6278:6278"  # morph
      - "6279:6279"  # qdrant
      - "6280:6280"  # p-new
    volumes:
      # Mount MCPM config (read-only for safety)
      - ${HOME}/.config/mcpm:/root/.config/mcpm:ro
      # Mount basic-memory data directory
      - ${HOME}/.basic-memory:/root/.basic-memory
      # Mount source code for dev mode
      - ./mcpm_source:/opt/mcpm_source
      # Mount MCPM CLI for API server
      - ./MCPM:/opt/mcpm-cli
      # Logs
      - mcpm_logs:/var/log/mcpm
    environment:
      # Profiles to run (comma-separated)
      MCPM_PROFILES: "p-pokeedge,memory,morph,qdrant"
      # API Keys (passed through from .env file)
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY:-}
      KAGI_API_KEY: ${KAGI_API_KEY:-}
      BRAVE_API_KEY: ${BRAVE_API_KEY:-}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      MORPH_API_KEY: ${MORPH_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # Qdrant connection (for mem0)
      QDRANT_URL: "http://qdrant:6333"
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6276/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge

volumes:
  postgres_data:
  qdrant_data:
  mcpm_logs:
