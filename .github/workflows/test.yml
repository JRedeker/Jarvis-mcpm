name: Test Suite

on:
  push:
    branches: [main, develop, refactor/*]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  go-tests:
    name: Go Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Jarvis

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: Jarvis/go.sum

      - name: Run Go tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Check coverage
        run: |
          go tool cover -func=coverage.out | tail -1
          COVERAGE=$(go tool cover -func=coverage.out | tail -1 | awk '{print $3}' | tr -d '%')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 60" | bc -l) )); then
            echo "::warning::Coverage is below 60%"
          fi

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./Jarvis/coverage.out
          flags: go
          fail_ci_if_error: false
        continue-on-error: true

  go-build:
    name: Go Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Jarvis

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: Jarvis/go.sum

      - name: Build Jarvis
        run: go build -o jarvis .

      - name: Verify binary
        run: |
          ./jarvis -h || true
          ls -la jarvis

  go-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Jarvis

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: Jarvis/go.sum

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: Jarvis
          args: --timeout=5m
        continue-on-error: true

  shell-tests:
    name: Shell Tests (bats)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install bats
        run: sudo apt-get update && sudo apt-get install -y bats

      - name: Run bats tests
        run: bats scripts/tests/*.bats

  complexity:
    name: Complexity Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install gum
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
          sudo apt update && sudo apt install -y gum

      - name: Install lizard
        run: pip install lizard

      - name: Run complexity scan
        run: source .github/scripts/ci-utils.sh && ci_complexity
        continue-on-error: true

  roadmap:
    name: Roadmap Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install gum
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
          sudo apt update && sudo apt install -y gum

      - name: Check roadmap consistency
        run: source .github/scripts/ci-utils.sh && ci_roadmap

  ai-code-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gum
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
          sudo apt update && sudo apt install -y gum

      - name: AI Review Context
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          HEAD_REF: ${{ github.head_ref }}
          BASE_REF: ${{ github.base_ref }}
        run: source .github/scripts/ci-utils.sh && ci_review "$PR_NUMBER" "$PR_TITLE" "$PR_AUTHOR" "$HEAD_REF" "$BASE_REF"

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build mcpm-daemon image
        run: docker build -t mcpm-daemon ./mcpm-daemon

      - name: Verify image
        run: docker images mcpm-daemon
