# Jarvis: Server Component

**Version:** 1.0.0
**Language:** Go (1.24+)

## Overview

This directory contains the source code for **Jarvis**, the Go-based MCP server that acts as the gateway between your AI Agent and the underlying system infrastructure.

While the [Root README](../README.md) covers high-level usage and tools, this document focuses on the internal development and structure of the Go application.

## üìÇ Directory Structure

*   **`main.go`**: The single-file entry point. It defines:
    *   **Tool Definitions:** The schema for every tool exposed to the agent (`install_server`, `bootstrap_system`, etc.).
    *   **Execution Logic:** The handlers that invoke the `mcpm` CLI via `exec.Command`.
    *   **MCP Server:** The server instance using `github.com/mark3labs/mcp-go`.
*   **`Dockerfile`**: Defines the container image for running Jarvis in a deployed environment (though local execution is preferred for tool management).

## üõ†Ô∏è Building from Source

### Prerequisites
*   Go 1.24 or higher
*   Make (optional, standard Go commands work fine)

### Compilation
Jarvis is built as a static binary.

```bash
go mod download
go build -o jarvis .
```

### Running Locally
You can run the binary directly to test the Stdio transport (though it will expect MCP JSON-RPC messages on stdin).

```bash
./jarvis
```

## üß© Key Implementation Details

### The `bootstrap_system` Tool
Located in `main.go`, this critical tool is responsible for self-initialization. It performs the following heuristic:
1.  Locates the project root by looking for the `MCPM/` directory.
2.  Runs `npm install` and `npm link` inside `MCPM/`.
3.  Runs `docker-compose up -d` in the root.

### The `scaffold_project` Tool
Transforms Jarvis into a Project Architect.
*   **Input:** `project_type` ("python", "go", "node"), `enable_ai_review` (bool).
*   **Actions:**
    1.  **Git:** Runs `git init`.
    2.  **Pre-Commit:** Generates `.pre-commit-config.yaml` tailored to the language.
    3.  **Hooks:** Runs `pip install pre-commit && pre-commit install`.
    4.  **AI Review:** Generates `.github/workflows/pr_agent.yml`.
    5.  **Ignore:** Creates `.gitignore`.

### The `fetch_diff_context` Tool
Enables the "Local Review Loop" for agents.
*   **Input:** `staged` (bool).
*   **Output:** A formatted Markdown report containing:
    *   Current Working Directory.
    *   `git status` output.
    *   `git diff` content (staged or HEAD).
*   **Use Case:** Allows the Agent to "see" its own changes before committing, enabling self-correction.

### The `suggest_profile` Tool (Smart Stacking)
Jarvis implements a "3-Layer Stacking" logic to determine the active toolset dynamically.
*   **Input:** `client_name` (string), `testing` (bool).
*   **Logic:**
    1.  **Base:** Detects project context (e.g., `project-pokeedge`) from CWD. Defaults to `project-new`.
    2.  **Adapter:** Appends client-specific profile (e.g., `client-codex`) if `client_name` is provided.
    3.  **Global:** Appends `memory`. Appends `testing-all-tools` if `testing=true`.
*   **Output:** JSON array of profile names.

### Client Configuration Management (`manage_client`)
Jarvis exposes advanced configuration for MCP clients, including path persistence for custom installations (like Kilo Code or Cline).
*   **Actions:** `edit`, `import`, `ls`, `config`.
*   **Path Persistence:**
    *   Use `action="config"` with `config_path="/path/to/settings.json"` to register a custom config location.
    *   Jarvis (via MCPM) remembers this path, so subsequent `edit` calls don't require the path argument.
    *   Essential for managing VS Code extensions that have unique storage paths.

### Shared Servers (Tunneling)
Jarvis manages a map of running background processes for the `share_server` tool.
*   **Concurrency:** Uses `sync.Mutex` to safely manage the state of shared tunnels.
*   **Process Management:** Captures `stdout` to detect the public URL generated by `mcpm share`.

## üß™ Testing
Currently, tests are manual via the Agent. Future improvements will add unit tests for the tool handlers.
