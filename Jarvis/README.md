# Jarvis: Server Component

**Version:** 1.0.0
**Language:** Go (1.24+)

## Overview

This directory contains the source code for **Jarvis**, the Go-based MCP server that acts as the gateway between your AI Agent and the underlying system infrastructure.

While the [Root README](../README.md) covers high-level usage and tools, this document focuses on the internal development and structure of the Go application.

## üìÇ Directory Structure

*   **`main.go`**: The single-file entry point. It defines:
    *   **Tool Definitions:** The schema for every tool exposed to the agent (`install_server`, `bootstrap_system`, etc.).
    *   **Execution Logic:** The handlers that invoke the `mcpm` CLI via `exec.Command`.
    *   **MCP Server:** The server instance using `github.com/mark3labs/mcp-go`.
*   **`Dockerfile`**: Defines the container image for running Jarvis in a deployed environment (though local execution is preferred for tool management).

## üõ†Ô∏è Building from Source

### Prerequisites
*   Go 1.24 or higher
*   Make (optional, standard Go commands work fine)

### Compilation
Jarvis is built as a static binary.

```bash
go mod download
go build -o jarvis .
```

### Running Locally
You can run the binary directly to test the Stdio transport (though it will expect MCP JSON-RPC messages on stdin).

```bash
./jarvis
```

## üß© Key Implementation Details

### The `bootstrap_system` Tool
Located in `main.go`, this critical tool is responsible for self-initialization. It performs the following heuristic:
1.  Locates the project root by looking for the `MCPM/` directory.
2.  Runs `npm install` and `npm link` inside `MCPM/`.
3.  Runs `docker-compose up -d` in the root.

### The `apply_devops_stack` Tool
Transforms Jarvis into a Project Architect.
*   **Input:** `project_type` (optional), `enable_ai_review` (bool), `force` (bool).
*   **Safe Mode:** Checks for existing configs first. Use `force=true` to overwrite.
*   **Actions:**
    1.  **Git:** Runs `git init`.
    2.  **Pre-Commit:** Generates `.pre-commit-config.yaml` tailored to the language.
    3.  **Hooks:** Runs `pip install pre-commit && pre-commit install`.
    4.  **AI Review:** Generates `.github/workflows/pr_agent.yml`.
    5.  **Ignore:** Creates `.gitignore`.

### The `analyze_project` Tool
Enables intelligent decision making for agents.
*   **Output:** JSON report of detected languages (`go`, `python`, `node`) and existing configurations (Git, Pre-commit, Workflows).
*   **Use Case:** Agents call this *before* applying the stack to determine the correct strategy.

### The `restart_infrastructure` Tool
Self-healing capability for the environment.
*   **Action:** Executes `scripts/manage-mcp.sh restart`.
*   **Result:** Safely reboots the Postgres and Qdrant containers and logs the output.

### The `fetch_diff_context` Tool
Enables the "Local Review Loop" for agents.
*   **Input:** `staged` (bool).
*   **Output:** A formatted Markdown report containing:
    *   Current Working Directory.
    *   `git status` output.
    *   `git diff` content (staged or HEAD).
*   **Use Case:** Allows the Agent to "see" its own changes before committing, enabling self-correction.

### The `suggest_profile` Tool (Smart Stacking)
Jarvis implements a "3-Layer Stacking" logic to determine the active toolset dynamically.
*   **Input:** `client_name` (string), `testing` (bool).
*   **Logic:**
    1.  **Base:** Detects project context (e.g., `project-pokeedge`) from CWD. Defaults to `project-new`.
    2.  **Adapter:** Appends client-specific profile (e.g., `client-codex`) if `client_name` is provided.
    3.  **Global:** Appends `memory`. Appends `testing-all-tools` if `testing=true`.
*   **Output:** JSON array of profile names.

### Client Configuration Management (`manage_client`)
Jarvis exposes advanced configuration for MCP clients, including path persistence for custom installations (like Kilo Code or Cline).
*   **Actions:** `edit`, `import`, `ls`, `config`.
*   **Path Persistence:**
    *   Use `action="config"` with `config_path="/path/to/settings.json"` to register a custom config location.
    *   Jarvis (via MCPM) remembers this path, so subsequent `edit` calls don't require the path argument.
    *   Essential for managing VS Code extensions that have unique storage paths.

### Shared Servers (Tunneling)
Jarvis manages a map of running background processes for the `share_server` tool.
*   **Concurrency:** Uses `sync.Mutex` to safely manage the state of shared tunnels.
*   **Process Management:** Captures `stdout` to detect the public URL generated by `mcpm share`.

## üß™ Testing

Jarvis includes a comprehensive test suite covering all critical functionality:

### Running Tests

```bash
# Run all tests
go test -v ./...

# Run tests with coverage
go test -v -cover ./...

# Run tests with race detection
go test -v -race ./...
```

### Test Coverage

**6 test functions covering 23+ test cases:**

1. **TestSetupLogging** - Verifies logging initialization and file creation
2. **TestBuildManageClientArgs** - Tests argument building for client management (5 scenarios)
3. **TestHandlersBasicExecution** - Tests tools without arguments (4 tools)
   - `handleListServers`
   - `handleCheckStatus`
   - `handleUsageStats`
   - `handleListSharedServers`
4. **TestHandlersWithArguments** - Tests tools with parameters (3 tools)
   - `handleInstallServer`
   - `handleSearchServers`
   - `handleServerInfo`
5. **TestMonitorShareProcess** - Tests URL extraction from share output (3 scenarios)

### Pre-Commit Hooks

Jarvis enforces quality standards via pre-commit hooks:
- **Go formatting** (`go fmt`)
- **Secret detection** (`gitleaks`)
- **Trailing whitespace** removal
- **End of file** fixes
- **Large file** detection
- **Merge conflict** markers

### CI/CD

GitHub Actions workflow runs on every push:
- Linting with `golangci-lint`
- Full test suite with race detection
- Build verification

## üéØ Phase 1 Improvements (Latest)

The latest release includes **Phase 1: Making Jarvis the Obvious Choice**, which positions Jarvis as the primary interface for AI agents:

### Enhanced Tool Descriptions

All 23 tools now feature **benefits-focused descriptions** that highlight:
- Specific capabilities and outcomes
- When and why to use the tool
- Key differentiators from alternatives

**Example:**
```go
// Before (generic):
"Install a new MCP server using MCPM"

// After (compelling):
"Install MCP servers with automatic dependency resolution, validation,
and clean error messages. Handles Docker, npm, and pip installations seamlessly."
```

### Smart Error Handling

Key tools now include **intelligent validation and helpful suggestions**:

**install_server:**
- ‚ùå Validates server name format (rejects spaces/slashes)
- üí° Suggests `search_servers()` on 404 errors
- ‚úÖ Provides next steps after installation
- Detects "already installed" and suggests profile management

**uninstall_server:**
- ‚ùå Validates non-empty server name
- üí° Suggests `list_servers()` when server not found
- ‚ö†Ô∏è Warns about profile updates after removal

**search_servers:**
- ‚ùå Validates non-empty query
- üí° Provides tips when no results found
- üí° Adds next step guidance to use `server_info()`

**manage_client:**
- ‚ùå Validates action against allowed values
- üí° Provides examples for each action type
- üí° Lists common client names when required
- ‚úÖ Adds next step guidance after successful edits

### Documentation Updates

- **CLAUDE.md** now features prominent "Using Jarvis (Primary Interface)" section
- Clear guidance on when to use Jarvis vs direct MCPM CLI
- Quick reference table with tool mappings
- Categorized tool reference (System/Server/Profile/Client/Project Management)
